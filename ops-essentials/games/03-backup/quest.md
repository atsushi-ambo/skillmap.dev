# Redis バックアップ設定

## 演習の目的
この演習では、Redis のバックアップ機能を有効にし、データの永続化を設定します。
デフォルトでは無効になっているバックアップ機能を有効にして、データが永続化されるように設定します。

## 現在の状況

- Redis サーバーが起動していますが、バックアップが無効になっています
- `save ""` の設定により、定期的なバックアップが無効化されています
- データはメモリ上にのみ存在し、ディスクには保存されていません

## 課題

1. Redis の設定ファイル (`redis.conf`) を修正して、バックアップを有効にしてください
2. 以下のバックアップポリシーを設定してください：
   - 900秒（15分）以内に1回以上の変更があった場合
   - 300秒（5分）以内に10回以上の変更があった場合
   - 60秒以内に10000回以上の変更があった場合
3. 変更を適用して、バックアップが正しく作成されることを確認してください

## ステップバイステップガイド

1. 現在の設定を確認します：
   ```bash
   docker compose exec redis cat /usr/local/etc/redis/redis.conf | grep -A 5 "^save"
   ```

2. `redis.conf` ファイルを編集して、バックアップ設定を有効にします：
   ```bash
   # バックアップ設定を有効化
   save 900 1
   save 300 10
   save 60 10000
   
   # 無効化されている設定をコメントアウト
   # save ""
   ```

3. 変更を適用するために Redis を再起動します：
   ```bash
   docker compose restart redis
   ```

4. バックアップファイルが作成されているか確認します：
   ```bash
   docker compose exec redis ls -la /data/
   ```

5. データを変更して、バックアップが作成されることを確認します：
   ```bash
   # Redis CLI に接続
   docker compose exec redis redis-cli
   
   # テストデータを追加
   SET test_key "This is a test value"
   
   # 変更をディスクに同期
   SAVE
   
   # 終了
   EXIT
   
   # バックアップファイルを確認
   docker compose exec redis ls -la /data/
   ```

## ヒント

- Redis のバックアップ設定は `save` ディレクティブで制御します
- 設定を変更した後は Redis を再起動する必要があります
- バックアップファイルは `/data/dump.rdb` に作成されます

## 確認方法

演習が完了したら、以下のコマンドで正しく設定できたか確認できます：

```bash
python3 ../../../../tools/cli/game.py play 03-backup
```

## 発展課題（余裕があれば挑戦してみてください）

- バックアップファイルを別の場所にコピーするスクリプトを作成してみましょう
- 定期的にバックアップを取得する仕組みを構築してみましょう
- バックアップからデータを復元する手順を確認してみましょう
